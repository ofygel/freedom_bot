Freedom Bot — Техническое задание (v1.4)

Дата: 2025‑09‑27 (Asia/Almaty)
Стек: TypeScript · Telegraf v4 · Node 18+ · PostgreSQL (Railway) · Webhook
Цель: промышленный, отказоустойчивый Telegram‑бот‑агрегатор такси/доставки для Казахстана.

> Этот документ кладётся в репозиторий и служит единственным источником истины для разработчиков, ревьюеров и ассистентов ИИ. Всё ниже — обязательные требования, критерии приёмки и операционные регламенты.




---

1) Общее описание

Роли:

Клиент — создаёт заказы (taxi / delivery).

Исполнитель — курьер или водитель. Доступ к заказам после верификации документов и при активной подписке (после 2‑дневного бесплатного пробного периода).

Модератор — проверяет документы исполнителей в мод‑канале.

Администратор — системные операции (бинд каналов, ручная модерация/подписки, обслуживание).


Ключевые принципы:

Работа как приложение: бот не «ломается» от сбоев БД. Все критичные операции обёрнуты в защитные паттерны (см. §10). Есть «safe‑mode» и понятные сообщения пользователю.

Идемпотентность всех действий, защита от «зомби‑кнопок», детерминированные результаты.

Простые, воспроизводимые миграции и жёсткая проверка совместимости схемы.

Минимум состояния в памяти, но есть временный in‑memory fallback для диалоговых шагов (на случай кратких деградаций БД).




---

2) Пользовательские сценарии (HLD)

2.1 Клиент

1. /start → приветствие → запрос номера кнопкой «Поделиться контактом» (обязательно).


2. Выбор города (4 фиксированных города, конфигурируемо).


3. Создание заказа: тип (такси/доставка) → адрес(а) с валидацией и нормализацией под 2GIS → цена/бюджет → подтверждение.


4. Публикация заказа в канале заказов с кнопкой «Взять».


5. Получение статусов: «принят», «в пути», «выполнен» / «отменён».



2.2 Исполнитель (курьер/водитель)

1. /start → номер → роль (курьер/водитель) → выбор города.


2. Проверка верификации документов.

Если не пройдена — бот требует прислать фото документов немедленно (без «ложных» кнопок).

При получении фото → пересылка в мод‑канал → статус «ожидание модерации».



3. Пробный период 2 дня активируется с момента первой успешной верификации (или с момента первого доступа к функционалу исполнителя — выбирается политикой проекта; по умолчанию — c момента одобрения модератором).


4. Во время пробного периода доступ к заказам полный. По окончании — требуется активная подписка.


5. При клике «Взять» в канале — атомарное закрепление заказа за исполнителем.


6. Выполнение, завершение, история.



2.3 Модератор

Получает заявки на верификацию в мод‑канале.

Кнопки: «Одобрить» / «Отклонить» (с комментарием).

Одобрение включает исполнителя, запускает (или фиксирует старт) пробного периода.


2.4 Администратор

/bind_verify_channel — привязка мод‑канала (хранится в БД).

/bind_orders_channel — привязка канала заказов.

/bind_stat_channel — привязка стат‑канала для отчётов и отслеживания действий (PII‑safe сообщения, агрегированные события).

Ручные операции: переоткрыть заказ, продлить подписку, перевести в safe‑mode, запустить техработы, аудит логов и т.д.

/bind_verify_channel — привязка мод‑канала (хранится в БД).

/bind_orders_channel — привязка канала заказов.

Ручные операции: переоткрыть заказ, продлить подписку, перевести в safe‑mode, запустить техработы, аудит логов и т.д.



---

3) Нефункциональные требования

Доступность: ≥ 99.5% мес.

Время ответа: p95 ≤ 2.5s (Telegram RTT включительно).

Безопасность: подписанные payload’ы, секрет вебхука, ограничение админ‑команд.

Наблюдаемость: pino‑логирование с троттлингом, метрики /metrics, трассировка correlation‑id.

Масштабирование: горизонтальное (идемпотентность обязательна).

Локализация: RU (минимум), KZ — план.

Правила данных: минимально‑необходимые персональные данные; описана политика хранения (§15).



---

4) Архитектура (LLD)

Слои:

bot/ — команды, сценории (flows), middlewares.

domain/ — чистая бизнес‑логика (use‑cases), без прямых SQL.

ports/ — интерфейсы адаптеров (репозитории, платежи, геокодинг).

adapters/ — реализации портов: PostgresRepo, InMemoryState, 2GISLinker и т.п.

infra/ — запуск вебхука, регистр middlewares, DI-контейнер.


Ключевой паттерн: Hexagonal / Ports & Adapters. Бизнес‑логика не зависит от конкретной БД.

Файловая структура (референс):

src/
  bot/
    commands/
    flows/
    middlewares/
  domain/
    entities/
    usecases/
    services/
  ports/
    Repo.ts          // интерфейсы хранилищ
    Payments.ts      // интерфейс платежей (на будущее)
  adapters/
    pg/
      PgRepo.ts
      migrations/
    memory/
      InMemoryState.ts
    util/
      TwoGIS.ts
      Signer.ts
  infra/
    server.ts        // webhook server (fastify/express)
    di.ts            // wiring зависимостей
  shared/
    types.ts
    errors.ts


---

5) Переменные окружения

Обязательные:

BOT_TOKEN — токен бота.

WEBHOOK_DOMAIN — публичный домен (например, freedombot-production.up.railway.app).

WEBHOOK_SECRET — случайная строка, путь: /bot/${WEBHOOK_SECRET}.

PORT — порт веб‑процесса (Railway предоставляет автоматически).

DATABASE_URL — строка подключения к Postgres.


Необязательные/рекомендуемые:

LOG_LEVEL (info|warn|error).

SAFE_MODE (true|false) — принудительный деградированный режим.

ORDERS_CHANNEL_ID, VERIFY_CHANNEL_ID, STATS_CHANNEL_ID — если хотим задать без /bind.

TZ = Asia/Almaty.


Стартовая инициализация: при запуске сервис проверяет (§9):

1. доступность БД; 2) совместимость схемы; 3) корректность каналов; 4) регистрацию вебхука. Если что‑то критично — включается safe‑mode с информированием.




---

6) Данные (логическая модель)

> Это не SQL, а каноническая модель. Реализация в БД обязана соответствовать.



users

id (uuid)

tg_id (bigint) UNIQUE

role (enum: client|courier|driver|moderator|admin)

phone (text)

phone_verified (boolean)

city (text)

verified (boolean) — документы одобрены

trial_started_at (timestamptz|null)

subscription_active_until (timestamptz|null)

created_at/updated_at


documents

id, user_id, photos (jsonb), status (pending|approved|rejected), moderator_id, comment, created_at.


orders

id (uuid), kind (taxi|delivery), client_id, city, route (jsonb)

price (numeric), status (open|claimed|in_progress|done|cancelled)

claimed_by (user_id|null), claimed_at, created_at/updated_at


order_events (аудит)

id, order_id, type, by_user, payload, ts


subscriptions

id, user_id, plan (weekly|monthly|other), starts_at, ends_at, source (manual|payment)


channels

kind (verify|orders|stats), channel_id (bigint), set_by, set_at


recent_actions (идемпотентность)

idempotency_key (pk), user_id, action, payload_hash, result, ts


sessions (FSM)

scope (enum: user|order|verify), scope_id, state (jsonb), flow_state (text), flow_payload (jsonb), last_step_at



---

7) Подписки и пробный период

Политика:

Пробный период 2 дня включается в момент одобрения верификации (по умолчанию). Политика может быть переключена на «момент первого доступа к функционалу исполнителя» флагом конфигурации.

Функция hasAccess(user, now) возвращает true, если:

1. user.verified = true И now < trial_started_at + 2 days, или


2. subscription_active_until >= now.



При окончании trial без подписки — все действия по взятию заказов блокируются с вежливым CTA «Оформить подписку».

Подписки могут устанавливаться вручную (админом) до интеграции платежей.


Критерий приёмки:

Новый исполнитель после одобрения → 48 часов имеет полный доступ; по истечении — доступ закрыт без подписки.



---

8) Верификация документов

Триггер: выбор роли курьер/водитель.

Если verified = false → бот запрашивает фото (инструкция: какие именно).

Полученные фото → в мод‑канал (VERIFY_CHANNEL_ID) с инлайн‑кнопками:

«Одобрить» → verified=true, trial_started_at = now() (если не установлен).

«Отклонить» → verified=false, комментарий обязателен.


Все решения логируются в documents + order_events (тип: verify.approved|rejected).



---

9) Совместимость схемы и миграции

Таблица schema_meta(version int, applied_at timestamptz).

На старте:

1. Проверить наличие обязательных таблиц/колонок (white‑list).


2. Сравнить schema_meta.version с REQUIRED_SCHEMA_VERSION (жёстко задан в коде).


3. Если несовместимо — включить safe‑mode, отключить опасные команды, вывести администратору инструкцию на миграцию.



Миграции идемпотентны: каждый шаг проверяет существование объектов.

Запрещается прямое обращение к «сырому» столбцу из домена — только через Repo методы/вьюхи/функции.



---

10) Отказоустойчивость и «бот как приложение»

Паттерны:

Circuit Breaker на БД: при повторных ошибках — краткосрочно отключать запросы, отвечать пользователю статусом «Техработы, попробуйте позже», не падая.

In‑Memory Fallback для FSM: базовые шаги (получить номер, спросить город, принять фото) сохраняются в памяти с TTL 10 минут; при восстановлении БД — «догоняем» записью.

Задача: бот не должен «вешаться» на кнопках — всегда отвечает и предлагает безопасный следующий шаг.


Компенсирующие действия: при ошибке публикации в канал — уведомить клиента и предложить повтор.

Идемпотентность: idempotency_key = hash(user_id + action + payload) в recent_actions.

Защита от зомби‑кнопок: каждая инлайн‑кнопка содержит подписанный (Signer) payload с exp и schema_version. Просроченные/несовместимые → «Эта кнопка устарела, вот актуальное меню».

Safe‑mode: флаг глобального состояния. В нём:

Разрешены только безопасные команды: /start, помощь, просмотр статуса.

Отключены приём/создание заказов.

Отображается плашка «идут работы/восстановление».


Таймауты и ретраи: DB statement_timeout ≤ 3s; повтор до 2 раз с jitter.

Рейт‑лимит логов: не более 100 лог‑сообщений/сек; агрегация повторов.



---

11) Гео и ссылки 2GIS

Нормализация адресов в единый формат; хранение исходного ввода + нормализованного.

Формирование ссылок под приложение 2GIS:
https://2gis.kz/<city>?m=<lon>,<lat>/18&q=<urlencoded address>
Падение геокодинга не должно рушить заказ — допускается заказ «по адресу без координат», но с пометкой.



---

12) Каналы и публикации

VERIFY_CHANNEL_ID — модерация документов.

ORDERS_CHANNEL_ID — лента заказов. Пост содержит: тип, город, ключевые поля, и кнопку «Взять».

STATS_CHANNEL_ID — стат‑канал для отчётности и трассировки ключевых событий:

Публикации: агрегированные сводки (час/сутки) и критические события в реальном времени.

Примеры событий: создание/отмена/взятие заказа, смены статусов, модерация, входы в safe‑mode/выход, ошибки уровня error (с маскировкой PII), превышение лимитов.

Анти‑спам: троттлинг, группировка одинаковых событий; при бурстах — только суммарные метрики.



«Взять» → атомарный апдейт: UPDATE orders SET status='claimed', claimed_by=$me WHERE id=$id AND status='open' RETURNING *;
Нулевой возврат = кто‑то успел раньше → показать «Заказ уже забрали».



---

13) FSM и UX‑поведение

sessions хранит: flow_state, flow_payload, last_step_at.

Автоподсказка: если 60–90 сек нет прогресса → один «напомнить следующий шаг» с актуальными кнопками.

После удаления юзера из БД любые старые кнопки невалидны — бот показывает «контекст восстановлен» и новый валидный шаг.

Undo (Отмена последнего шага) — где безопасно (например, редактирование адреса до публикации).



---

14) Безопасность

Вебхук только по пути /bot/${WEBHOOK_SECRET}.

Подпись payload инлайн‑кнопок (HMAC‑SHA256, Signer), exp ≤ 10 минут.

Роли и доступы валидируются в middleware (админ/модератор команды — только whitelisted пользователи/чаты).

Валидация входов (строки, медиаконтент, размеры, анти‑XSS для отображения превью).



---

15) Политика данных и хранение

Храним: tg_id, телефон, город, статусы, документы (идентификаторы файлов/фото), историю заказов.

Сроки хранения документов: по умолчанию 12 мес., затем архив/удаление.

Логи с персональными данными — не более 14 дней (агрегированные метрики — дольше).

Экспорт/удаление по запросу пользователя — вручную админом.



---

16) Логирование и метрики

pino: level=info в проде, sensitive поля маскируются.

Обязательные поля: request_id, user_id, role, action, result, latency_ms.

Троттлинг логов: агрегировать повторяющиеся события, чтобы не ловить лимит Railway.

/metrics (Prom‑совместимые): счётчики апдейтов, ошибок по типам, latency гистограммы.

Отражение в стат‑канал:

Критические события (error, переходы safe‑mode, сбои публикаций) отправляются в STATS_CHANNEL_ID с батчированием.

Ежечасные/ежедневные дайджесты: создано/принято/выполнено/отменено заказов, средняя задержка, отказоустойчивые срабатывания (ретраи, circuit‑breaker).



---

17) CI/CD и эксплуатация

GitHub Actions: lint → build → unit → e2e (mock Telegram) → deploy Railway.

Health‑check endpoint /healthz: ok, db=up|down, schema=ok|mismatch, safe_mode=on|off.

Релизная дисциплина: REQUIRED_SCHEMA_VERSION увеличивается при несовместимых изменениях.

Rollback: последний успешный образ + миграция down (если предусмотрено) или включение safe‑mode.



---

18) Тестирование (критерии приёмки)

Юнит: use‑cases, Signer, idempotency, Repo‑заглушки.
Интеграционные: с Postgres (в контейнере), с имитацией Telegram Update.
E2E сценарии (минимум):

1. Клиент создаёт заказ такси → пост в канал → исполнитель забирает.


2. Исполнитель без верификации пытается «взять» → требование документов → модератор одобряет → trial=48h → доступ есть.


3. Trial истёк → попытка «взять» блокируется, предлагается «Оформить подписку».


4. Падение БД на шаге «взять» → бот не падает: сообщает о техработах и предлагает повторить.


5. Старая кнопка (устаревший payload) → бот показывает «кнопка устарела» и выдаёт новое меню.


6. Стат‑канал получает: (а) реальные‑время критические события, (б) сводку за период по метрикам заказов и инцидентам.




---

19) Сообщения и копирайтинг (RU)

Телефон обязателен: «Чтобы продолжить, нажмите Поделиться контактом. Мы используем номер только для связи по заказу.»

Верификация: «Прикрепите фото документов. Без них доступ к заказам ограничен.»

Trial активен: «Вам доступен бесплатный доступ ещё: ⏳ {HH:mm | DD:HH}.»

Trial окончен: «Срок бесплатного доступа истёк. Оформите подписку, чтобы продолжить.»

Техработы: «Сервис временно недоступен. Уже чиним. Попробуйте позже.»



---

20) Анти‑гонка и идемпотентность (детали)

Все мутационные операции принимают idempotency_key.

Перед действием проверяется recent_actions; при совпадении — возвращается сохранённый результат.

Инлайн‑кнопки содержат nonce и exp; повтор по той же кнопке после успеха → «Действие уже выполнено».



---

21) Интерфейсы портов (референс, TS)

// ports/Repo.ts
export interface Repo {
  getUserByTgId(tgId: bigint): Promise<User | null>
  upsertUser(u: Partial<User> & { tgId: bigint }): Promise<User>
  setVerification(userId: string, ok: boolean): Promise<void>
  startTrialIfEmpty(userId: string, at: Date): Promise<void>
  hasAccess(userId: string, now: Date): Promise<boolean>

  createOrder(input: CreateOrder): Promise<Order>
  publishableOrder(orderId: string): Promise<OrderView>
  tryClaimOrder(orderId: string, executorId: string): Promise<ClaimResult>

  saveRecentAction(key: string, res: unknown): Promise<void>
  findRecentAction(key: string): Promise<unknown | null>

  getChannel(kind: 'verify'|'orders'): Promise<string | null>
  setChannel(kind: 'verify'|'orders', id: string): Promise<void>
}

// ports/Payments.ts (на будущее)
export interface Payments {
  createCheckout(userId: string, plan: 'weekly'|'monthly'): Promise<{ url: string }>
  handleWebhook(raw: unknown): Promise<void>
}


---

22) Runbook (эксплуатация)

Привязка каналов: /bind_verify_channel, /bind_orders_channel, /bind_stat_channel из админ‑чата; убедиться, что бот — админ в каналах.

Миграция сломалась: включить SAFE_MODE=true, задеплоить; исправить миграции; перезапустить; проверить /healthz.

Railway «rate limit logs»: снизить уровень логов до warn, включить агрегацию повторов.

Ошибка 42703 (missing column): несовместимая схема → миграция + bump REQUIRED_SCHEMA_VERSION.



---

23) Чек‑лист готовности к продакшену

[ ] Вебхук активен на https://{WEBHOOK_DOMAIN}/bot/{WEBHOOK_SECRET}.

[ ] schema_meta.version == REQUIRED_SCHEMA_VERSION.

[ ] Каналы привязаны и доступны (verify, orders, stats).

[ ] Верификация → модерация → trial 48h → доступ.

[ ] Кнопки подписаны, exp проверяется.

[ ] Идемпотентность: повторные нажатия безопасны.

[ ] Падение БД не валит бот: safe‑mode, сообщения пользователю, ретраи, лог‑алерты.

[ ] Метрики и health‑check отдают корректные статусы.

[ ] Тесты E2E (из §18) зелёные.

